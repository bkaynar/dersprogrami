name: Deploy (Auto Backup & Build)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: KodlarÄ± Github'dan Ã‡ek
        uses: actions/checkout@v4

      # 1. DosyalarÄ± GeÃ§ici Bir KlasÃ¶re YÃ¼kle (SCP)
      - name: DosyalarÄ± Sunucuya GÃ¶nder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 25416
          # KodlarÄ± Ã¶nce "upload-temp" adÄ±nda geÃ§ici bir yere atÄ±yoruz
          target: "/home/${{ secrets.SERVER_USER }}/upload-temp"
          source: "."
          rm: true # Ã–nceki temp kirliliÄŸini temizle

      # 2. Sunucuda Yedekle, TaÅŸÄ± ve BaÅŸlat
      - name: Sunucuda Ä°ÅŸlemleri Yap
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 25416
          script: |
            set -e # Hata olursa iÅŸlemi durdur

            # --- DEÄÄ°ÅKENLER ---
            # Ana kullanÄ±cÄ± dizini (Ã–rn: /home/deploy)
            BASE_DIR="/home/${{ secrets.SERVER_USER }}"
            # CanlÄ± projenin Ã§alÄ±ÅŸacaÄŸÄ± yer
            LIVE_DIR="$BASE_DIR/my-project"
            # Az Ã¶nce yÃ¼klediÄŸimiz yeni kodlar
            NEW_CODE_DIR="$BASE_DIR/upload-temp"
            # Yedeklerin tutulacaÄŸÄ± klasÃ¶r
            BACKUPS_ROOT="$BASE_DIR/dersprogrami-backup"

            echo "ï¿½ Deployment BaÅŸlÄ±yor..."
            echo "ğŸ“‚ Ana Dizin: $BASE_DIR"

            # 1. Yedekleme KlasÃ¶rÃ¼nÃ¼ OluÅŸtur (Yoksa)
            mkdir -p "$BACKUPS_ROOT"

            # 2. Storage ve Firebase DosyalarÄ±nÄ± Koru (Yedekle)
            echo "ğŸ’¾ Mevcut veriler korunuyor..."
            mkdir -p /tmp/deploy-protection

            if [ -d "$LIVE_DIR/storage/app/public" ]; then
              cp -r "$LIVE_DIR/storage/app/public" /tmp/deploy-protection/
            fi

            if [ -f "$LIVE_DIR/storage/app/firebase/firebase-credentials.json" ]; then
              mkdir -p /tmp/deploy-protection/firebase
              cp "$LIVE_DIR/storage/app/firebase/firebase-credentials.json" /tmp/deploy-protection/firebase/
            fi

            # 3. Mevcut Projeyi ArÅŸivle (Backup)
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_PATH="$BACKUPS_ROOT/backup_$TIMESTAMP"

            if [ -d "$LIVE_DIR" ]; then
              echo "ğŸ“¦ Eski proje yedekleniyor: $BACKUP_PATH"
              # Eski projeyi silmek yerine backup klasÃ¶rÃ¼ne taÅŸÄ±yoruz
              mv "$LIVE_DIR" "$BACKUP_PATH"
            fi

            # 4. Yeni KodlarÄ± Yerine Koy
            echo "ğŸ”„ Yeni kodlar canlÄ±ya alÄ±nÄ±yor..."
            mv "$NEW_CODE_DIR" "$LIVE_DIR"

            # 5. Korunan Verileri Geri YÃ¼kle (Restore)
            echo "â™»ï¸ Veriler geri yÃ¼kleniyor..."
            mkdir -p "$LIVE_DIR/storage/app"

            if [ -d "/tmp/deploy-protection/public" ]; then
              cp -r /tmp/deploy-protection/public "$LIVE_DIR/storage/app/"
            fi

            if [ -f "/tmp/deploy-protection/firebase/firebase-credentials.json" ]; then
              mkdir -p "$LIVE_DIR/storage/app/firebase"
              cp /tmp/deploy-protection/firebase/firebase-credentials.json "$LIVE_DIR/storage/app/firebase/"
            fi

            # GeÃ§ici dosyalarÄ± temizle
            rm -rf /tmp/deploy-protection

            # 6. .ENV DosyasÄ± ve Docker HazÄ±rlÄ±ÄŸÄ±
            cd "$LIVE_DIR"

            # EÄŸer eski backup'ta .env varsa onu kullan
            if [ -f "$BACKUP_PATH/.env" ]; then
              echo "ğŸ“„ Eski .env dosyasÄ± kopyalanÄ±yor..."
              cp "$BACKUP_PATH/.env" .env
            elif [ -f .env.example ]; then
              echo "âš ï¸ Eski .env bulunamadÄ±, .env.example'dan oluÅŸturuluyor..."
              cp .env.example .env
            else
              touch .env
            fi

            # Docker MySQL ayarlarÄ±nÄ± zorla uygula (eski env'de farklÄ± olabilir)
            echo "ğŸ”§ Docker MySQL ayarlarÄ± uygulanÄ±yor..."
            sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
            sed -i 's/^DB_HOST=.*/DB_HOST=mysql/' .env
            sed -i 's/^DB_PORT=.*/DB_PORT=3306/' .env
            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=ders_programi/' .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=root/' .env
            sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=Aygulen12./' .env
            sed -i 's/^REDIS_HOST=.*/REDIS_HOST=redis/' .env
            sed -i 's/^APP_ENV=.*/APP_ENV=production/' .env
            sed -i 's/^APP_DEBUG=.*/APP_DEBUG=false/' .env

            # 7. Ä°zinler ve Docker Build
            echo "ï¿½ Docker Build BaÅŸlÄ±yor..."

            # Ä°zinleri ayarla
            chmod -R 777 storage bootstrap/cache 2>/dev/null || true

            # Docker'Ä± ayaÄŸa kaldÄ±r
            docker compose up -d --build --remove-orphans

            # Container'larÄ±n baÅŸlamasÄ±nÄ± bekle
            echo "â³ Container'lar baÅŸlatÄ±lÄ±yor..."
            sleep 15

            # Laravel komutlarÄ±
            echo "ğŸ”§ Laravel ayarlarÄ± yapÄ±lÄ±yor..."

            # Composer install (production)
            docker compose exec -T app composer install --no-dev --optimize-autoloader 2>/dev/null || true

            # APP_KEY yoksa oluÅŸtur
            if ! grep -q "APP_KEY=base64:" .env; then
              echo "ğŸ”‘ APP_KEY oluÅŸturuluyor..."
              docker compose exec -T app php artisan key:generate --force
            fi

            docker compose exec -T app php artisan storage:link 2>/dev/null || true
            docker compose exec -T app php artisan migrate --force 2>/dev/null || true
            docker compose exec -T app php artisan optimize:clear
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache

            # 8. Temizlik (Eski Backup'larÄ± Sil - 5 taneden fazlasÄ±nÄ± tutma)
            echo "ğŸ§¹ Eski yedekler temizleniyor (Son 5 yedek tutulur)..."
            cd "$BACKUPS_ROOT"
            ls -dt backup_* | tail -n +6 | xargs -I {} rm -rf {} 2>/dev/null || true

            echo "âœ… Ä°ÅLEM BAÅARIYLA TAMAMLANDI!"
            echo "ğŸŒ Proje dizini: $LIVE_DIR"
            echo "ğŸ“¦ Son yedek: $BACKUP_PATH"
