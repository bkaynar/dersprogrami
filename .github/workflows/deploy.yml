name: Deploy (Auto Build)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Kodlarƒ± Github'dan √áek
        uses: actions/checkout@v4

      # 1. Dosyalarƒ± Ge√ßici Bir Klas√∂re Y√ºkle (SCP)
      - name: Dosyalarƒ± Sunucuya G√∂nder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 25416
          target: "/home/${{ secrets.SERVER_USER }}/upload-temp"
          source: "."
          rm: true

      # 2. Sunucuda Ta≈üƒ± ve Ba≈ülat
      - name: Sunucuda ƒ∞≈ülemleri Yap
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 25416
          script: |
            set -e

            # --- DEƒûƒ∞≈ûKENLER ---
            BASE_DIR="/home/${{ secrets.SERVER_USER }}"
            LIVE_DIR="$BASE_DIR/ders-programi"
            NEW_CODE_DIR="$BASE_DIR/upload-temp"

            echo "üöÄ Deployment Ba≈ülƒ±yor..."

            # 1. Storage dosyalarƒ±nƒ± koru
            echo "üíæ Mevcut veriler korunuyor..."
            mkdir -p /tmp/deploy-protection

            if [ -d "$LIVE_DIR/storage/app/public" ]; then
              cp -r "$LIVE_DIR/storage/app/public" /tmp/deploy-protection/
            fi

            if [ -f "$LIVE_DIR/storage/app/firebase/firebase-credentials.json" ]; then
              mkdir -p /tmp/deploy-protection/firebase
              cp "$LIVE_DIR/storage/app/firebase/firebase-credentials.json" /tmp/deploy-protection/firebase/
            fi

            # Eski .env'i koru
            if [ -f "$LIVE_DIR/.env" ]; then
              cp "$LIVE_DIR/.env" /tmp/deploy-protection/
            fi

            # 2. Eski projeyi sil, yenisini koy
            echo "üîÑ Yeni kodlar canlƒ±ya alƒ±nƒ±yor..."
            rm -rf "$LIVE_DIR"
            mv "$NEW_CODE_DIR" "$LIVE_DIR"

            # 3. Korunan dosyalarƒ± geri y√ºkle
            echo "‚ôªÔ∏è Veriler geri y√ºkleniyor..."
            mkdir -p "$LIVE_DIR/storage/app"

            if [ -d "/tmp/deploy-protection/public" ]; then
              cp -r /tmp/deploy-protection/public "$LIVE_DIR/storage/app/"
            fi

            if [ -f "/tmp/deploy-protection/firebase/firebase-credentials.json" ]; then
              mkdir -p "$LIVE_DIR/storage/app/firebase"
              cp /tmp/deploy-protection/firebase/firebase-credentials.json "$LIVE_DIR/storage/app/firebase/"
            fi

            # .env'i geri y√ºkle veya olu≈ütur
            if [ -f "/tmp/deploy-protection/.env" ]; then
              cp /tmp/deploy-protection/.env "$LIVE_DIR/.env"
            elif [ -f "$LIVE_DIR/.env.example" ]; then
              cp "$LIVE_DIR/.env.example" "$LIVE_DIR/.env"
            fi

            rm -rf /tmp/deploy-protection

            # 4. .ENV ayarlarƒ±
            cd "$LIVE_DIR"

            echo "üîß Docker MySQL ayarlarƒ± uygulanƒ±yor..."
            sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
            sed -i 's/^DB_HOST=.*/DB_HOST=mysql/' .env
            sed -i 's/^DB_PORT=.*/DB_PORT=3306/' .env
            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=ders_programi/' .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=root/' .env
            sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=Aygulen12./' .env
            sed -i 's/^REDIS_HOST=.*/REDIS_HOST=redis/' .env
            sed -i 's/^APP_ENV=.*/APP_ENV=production/' .env
            sed -i 's/^APP_DEBUG=.*/APP_DEBUG=false/' .env

            # 5. ƒ∞zinler ve Docker Build
            echo "ÔøΩ Docker Build Ba≈ülƒ±yor..."
            chmod -R 777 storage bootstrap/cache 2>/dev/null || true

            docker compose up -d --build --remove-orphans

            echo "‚è≥ Container'lar ba≈ülatƒ±lƒ±yor..."
            sleep 15

            # 6. Laravel komutlarƒ±
            echo "üîß Laravel ayarlarƒ± yapƒ±lƒ±yor..."
            docker compose exec -T app composer install --no-dev --optimize-autoloader 2>/dev/null || true

            if ! grep -q "APP_KEY=base64:" .env; then
              echo "üîë APP_KEY olu≈üturuluyor..."
              docker compose exec -T app php artisan key:generate --force
            fi

            docker compose exec -T app php artisan storage:link 2>/dev/null || true
            docker compose exec -T app php artisan migrate --force 2>/dev/null || true
            docker compose exec -T app php artisan optimize:clear
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache

            echo "‚úÖ DEPLOYMENT TAMAMLANDI!"
            echo "üåç Proje: $LIVE_DIR"
